'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.encryptWithMD5 = exports.auth = exports.checkExpire = exports.parse = exports.create = void 0;
const crypto = require("crypto");
const config = {
    secret: '12312312412142121',
    expire: -1
};
const key = crypto.scryptSync(config.secret, '盐值', 32);
const iv = Buffer.alloc(16, 0);
function create(uid) {
    const msg = uid + '|' + Date.now();
    const cipher = crypto.createCipheriv('aes256', key, iv);
    let enc = cipher.update(msg, 'utf8', 'hex');
    enc += cipher.final('hex');
    return enc;
}
exports.create = create;
;
function parse(token) {
    const decipher = crypto.createDecipheriv('aes256', key, iv);
    let dec;
    try {
        dec = decipher.update(token, 'hex', 'utf8');
        dec += decipher.final('utf8');
    }
    catch (err) {
        console.error('[token] fail to decrypt token. %j', token);
        return null;
    }
    const ts = dec.split('|');
    if (ts.length !== 2) {
        console.error('illegal token', dec);
        return null;
    }
    return { id: ts[0], timestamp: Number(ts[1]) };
}
exports.parse = parse;
;
function checkExpire(token) {
    if (config.expire < 0) {
        return true;
    }
    return (Date.now() - token.timestamp) < config.expire;
}
exports.checkExpire = checkExpire;
;
function auth(token) {
    const res = parse(token);
    if (!res) {
        return 'token非法';
    }
    if (!checkExpire(res)) {
        return 'token过时';
    }
    return null;
}
exports.auth = auth;
;
function encryptWithMD5(content) {
    if (!content) {
        return '';
    }
    const md5 = crypto.createHash('md5');
    md5.update(content);
    return md5.digest('hex');
}
exports.encryptWithMD5 = encryptWithMD5;
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9rZW5TZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vYXBwL3NlcnZpY2VzL2hhbGwvdG9rZW5TZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQzs7O0FBRWIsaUNBQWtDO0FBRWxDLE1BQU0sTUFBTSxHQUFHO0lBQ1gsTUFBTSxFQUFFLG1CQUFtQjtJQUMzQixNQUFNLEVBQUUsQ0FBQyxDQUFDO0NBQ2IsQ0FBQztBQUNGLE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFDdkQsTUFBTSxFQUFFLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7QUFRL0IsU0FBZ0IsTUFBTSxDQUFDLEdBQVc7SUFDOUIsTUFBTSxHQUFHLEdBQUcsR0FBRyxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDbkMsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLGNBQWMsQ0FBQyxRQUFRLEVBQUUsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ3hELElBQUksR0FBRyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLE1BQU0sRUFBRSxLQUFLLENBQUMsQ0FBQztJQUM1QyxHQUFHLElBQUksTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUMzQixPQUFPLEdBQUcsQ0FBQztBQUNmLENBQUM7QUFORCx3QkFNQztBQUFBLENBQUM7QUFRRixTQUFnQixLQUFLLENBQUMsS0FBSztJQUN2QixNQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxFQUFFLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUM1RCxJQUFJLEdBQVcsQ0FBQztJQUNoQixJQUFJO1FBQ0EsR0FBRyxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLEtBQUssRUFBRSxNQUFNLENBQUMsQ0FBQztRQUM1QyxHQUFHLElBQUksUUFBUSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztLQUNqQztJQUFDLE9BQU8sR0FBRyxFQUFFO1FBQ1YsT0FBTyxDQUFDLEtBQUssQ0FBQyxtQ0FBbUMsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUMxRCxPQUFPLElBQUksQ0FBQztLQUNmO0lBQ0QsTUFBTSxFQUFFLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUMxQixJQUFJLEVBQUUsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1FBQ2pCLE9BQU8sQ0FBQyxLQUFLLENBQUMsZUFBZSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ3BDLE9BQU8sSUFBSSxDQUFDO0tBQ2Y7SUFDRCxPQUFPLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxTQUFTLEVBQUUsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7QUFDbkQsQ0FBQztBQWhCRCxzQkFnQkM7QUFBQSxDQUFDO0FBUUYsU0FBZ0IsV0FBVyxDQUFDLEtBQUs7SUFDN0IsSUFBSSxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtRQUNuQixPQUFPLElBQUksQ0FBQztLQUNmO0lBQ0QsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxLQUFLLENBQUMsU0FBUyxDQUFDLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQztBQUMxRCxDQUFDO0FBTEQsa0NBS0M7QUFBQSxDQUFDO0FBTUYsU0FBZ0IsSUFBSSxDQUFDLEtBQUs7SUFDdEIsTUFBTSxHQUFHLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3pCLElBQUksQ0FBQyxHQUFHLEVBQUU7UUFDTixPQUFPLFNBQVMsQ0FBQztLQUNwQjtJQUNELElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLEVBQUU7UUFDbkIsT0FBTyxTQUFTLENBQUM7S0FDcEI7SUFDRCxPQUFPLElBQUksQ0FBQztBQUNoQixDQUFDO0FBVEQsb0JBU0M7QUFBQSxDQUFDO0FBR0YsU0FBZ0IsY0FBYyxDQUFDLE9BQW1DO0lBQzlELElBQUksQ0FBQyxPQUFPLEVBQUU7UUFDVixPQUFPLEVBQUUsQ0FBQztLQUNiO0lBQ0QsTUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNyQyxHQUFHLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3BCLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUM3QixDQUFDO0FBUEQsd0NBT0M7QUFBQSxDQUFDIn0=