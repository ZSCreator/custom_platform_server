'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.timerExamineOrder = exports.getNoteNum = exports.sendNotePay = exports.getChannelPay = exports.setChannelPay = void 0;
const utils = require("../../utils");
const hallConst = require("../../consts/hallConst");
const MongoManager = require("../../common/dao/mongoDB/lib/mongoManager");
const payOrder = MongoManager.pay_order;
const payType = MongoManager.pay_type;
let pay_channel;
let currShop;
let payNoteConfig;
let noteNum = [];
const setChannelPay = async function (app) {
    pay_channel = app.channelService.createChannel(hallConst.PAY_CHANNEL);
    await getShopConfig();
    startPayNotice();
    startTimerGetConfig();
};
exports.setChannelPay = setChannelPay;
const getChannelPay = function () {
    return pay_channel;
};
exports.getChannelPay = getChannelPay;
async function getShopAndNoteConfig() {
    const allPrice = MongoManager.system_shop_gold;
    const result = await allPrice.find({ isOpen: true, language: 'chinese' });
    return Promise.resolve({ shopConfig: result, noteConfig: null });
}
const getShopConfig = async function () {
    const { shopConfig, noteConfig } = await getShopAndNoteConfig();
    currShop = shopConfig;
    payNoteConfig = noteConfig;
    return Promise.resolve();
};
const startTimerGetConfig = function () {
    setInterval(() => {
        getShopConfig();
    }, 2 * 60 * 1000);
};
const sendNotePay = function ({ uid, isChongzhi, gold, tixianGold }) {
    const data = {
        name: '玩家',
        uid: uid,
        content: isChongzhi ? utils.changeMoneyToGold(gold) : utils.changeMoneyToGold(tixianGold),
        type: isChongzhi ? 'chongzhi' : 'tixian'
    };
    if (noteNum.length >= 10) {
        noteNum.shift();
    }
    noteNum.push(data);
    const playerNum = pay_channel && pay_channel.getMembers();
    playerNum && playerNum.length && pay_channel.pushMessage('payNote', data);
};
exports.sendNotePay = sendNotePay;
const startPayNotice = function () {
    const time = 1000;
    function timer() {
        (payNoteConfig.time[0] > payNoteConfig.time[1]) && (payNoteConfig.time[0] = payNoteConfig.time[1]);
        let times = utils.random(payNoteConfig.time[0] * time, payNoteConfig.time[1] * time);
        setTimeout(() => {
            let isChongzhi = utils.random(1, 10) <= payNoteConfig.chongzhi ? true : false;
            const gold = currShop.length ? currShop[utils.random(0, currShop.length - 1)].gold : 100;
            const tixianGold = payNoteConfig.tixianBasic * payNoteConfig.ratio * utils.random(1, 10);
            (0, exports.sendNotePay)({ uid: utils.randomId(6), isChongzhi, gold, tixianGold });
            timer();
        }, times);
    }
    timer();
};
const getNoteNum = function () {
    return noteNum;
};
exports.getNoteNum = getNoteNum;
const timerExamineOrder = async function () {
    setInterval(async () => {
        let order = await payOrder.find({ aisleId: { $exists: true }, callBackTime: { $exists: true } });
        const openPay = await payType.find({ isOpen: true });
        const beAisle = [], noAisle = [];
        openPay.forEach(m => {
            let opts = { aisleId: null, callBackSucceed: null, callBackAll: null, meanTime: null };
            let allOrder = order.filter(o => o.aisleId == m.id);
            let currOrder = allOrder.filter(o => o.status == 1);
            let allTime = 0;
            opts.aisleId = m.id;
            opts.callBackSucceed = currOrder.length;
            opts.callBackAll = allOrder.length;
            if (currOrder.length) {
                currOrder.forEach(o => allTime += (o.callBackTime - o.time));
                opts.meanTime = allTime / currOrder.length;
                beAisle.push(opts);
            }
            !allOrder.length && noAisle.push({ aisleId: m.id });
        });
        beAisle.sort((a, b) => {
            return a.meanTime - b.meanTime;
        });
        const isNoSort = noAisle.map(async (m, i) => {
            await payType.updateOne({ id: m.aisleId }, { $set: { sort: i + 1 } });
        });
        await Promise.all(isNoSort);
        const isBeSort = beAisle.map(async (m, i) => {
            await payType.updateOne({ id: m.aisleId }, {
                $set: {
                    sort: noAisle.length + 1 + i,
                    callBackDelay: m.meanTime.toFixed(2),
                    callBackSucceed: m.callBackSucceed,
                    callBackAll: m.callBackAll
                }
            });
        });
        await Promise.all(isBeSort);
    }, 2 * 60 * 1000);
};
exports.timerExamineOrder = timerExamineOrder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGF5U2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2FwcC9zZXJ2aWNlcy9oYWxsL3BheVNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7QUFDYixxQ0FBc0M7QUFDdEMsb0RBQXFEO0FBQ3JELDBFQUEyRTtBQUczRSxNQUFNLFFBQVEsR0FBRyxZQUFZLENBQUMsU0FBUyxDQUFDO0FBQ3hDLE1BQU0sT0FBTyxHQUFHLFlBQVksQ0FBQyxRQUFRLENBQUM7QUFFdEMsSUFBSSxXQUFXLENBQUM7QUFDaEIsSUFBSSxRQUFRLENBQUM7QUFDYixJQUFJLGFBQWEsQ0FBQztBQUNsQixJQUFJLE9BQU8sR0FBRyxFQUFFLENBQUM7QUFFVixNQUFNLGFBQWEsR0FBRyxLQUFLLFdBQVcsR0FBRztJQUM1QyxXQUFXLEdBQUcsR0FBRyxDQUFDLGNBQWMsQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQ3RFLE1BQU0sYUFBYSxFQUFFLENBQUM7SUFDdEIsY0FBYyxFQUFFLENBQUM7SUFFakIsbUJBQW1CLEVBQUUsQ0FBQztBQUMxQixDQUFDLENBQUE7QUFOWSxRQUFBLGFBQWEsaUJBTXpCO0FBRU0sTUFBTSxhQUFhLEdBQUc7SUFDekIsT0FBTyxXQUFXLENBQUM7QUFDdkIsQ0FBQyxDQUFBO0FBRlksUUFBQSxhQUFhLGlCQUV6QjtBQUdELEtBQUssVUFBVSxvQkFBb0I7SUFDL0IsTUFBTSxRQUFRLEdBQUcsWUFBWSxDQUFDLGdCQUFnQixDQUFDO0lBRS9DLE1BQU0sTUFBTSxHQUFHLE1BQU0sUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUM7SUFVMUUsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsSUFBSSxFQUFFLENB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