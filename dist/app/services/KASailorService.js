'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.getWinORLossResult = exports.getRandomLotteryResult = exports.settle = exports.lottery = void 0;
const GameUtil_1 = require("../utils/GameUtil");
const lotteryKASailor = { 1: "k1", 2: "k2", 3: "k3", 4: "k4", 5: "k5", 6: "k6" };
const random = function (min, max) {
    if (max % 1 !== 0 || min % 1 !== 0) {
        throw "min, max不能为非整数";
    }
    const MAX = Math.max(min, max);
    const MIN = Math.min(min, max);
    const MM = MAX - MIN + 1;
    return Math.floor(Math.random() * MM) + MIN;
};
function lottery() {
    const result = [random(1, 6), random(1, 6), random(1, 6)];
    const arr = [];
    let i = 0;
    while (i < 3) {
        arr.push(lotteryKASailor[result[i]]);
        i += 1;
    }
    return arr;
}
exports.lottery = lottery;
;
function settle(lotteryResult, userBets) {
    const winArea = lotteryResult, userWin = {}, winner = {}, uidArr = Object.keys(userBets), userWinInfo = {};
    let allBetNum = 0, totalRebate = 0;
    for (let i = uidArr.length - 1; i >= 0; --i) {
        const uid = uidArr[i], userBet = userBets[uid], betArr = Object.keys(userBet);
        userWin[uid] = {};
        userWinInfo[uid] = {};
        userWinInfo[uid].maxOdds = 0;
        userWinInfo[uid].allWin = 0;
        for (let len = betArr.length - 1; len >= 0; --len) {
            const area = betArr[len];
            allBetNum += userBet[area];
            if (winArea.includes(area)) {
                const areaCount = winArea.filter(m => m === area).length;
                if (userWinInfo[uid].maxOdds < areaCount) {
                    userWinInfo[uid].maxOdds = areaCount;
                }
                userWin[uid][area] = {
                    win: userBet[area] * areaCount + userBet[area],
                    winArea: area,
                    profit: userBet[area] * areaCount
                };
                totalRebate += userWin[uid][area].win;
                userWinInfo[uid].allWin += userWin[uid][area].win;
                winner[area] = { win: userBet[area] };
            }
        }
    }
    return { userWin, totalRebate, allBetNum, lotteryResult, userWinInfo };
}
exports.settle = settle;
;
const getRandomLotteryResult = (userBets) => {
    const lotteryResult = lottery();
    return settle(lotteryResult, userBets);
};
exports.getRandomLotteryResult = getRandomLotteryResult;
const getWinORLossResult = (players, userBet, filterType, bet, isSystemWin) => {
    let result;
    for (let i = 0; i < 100; i++) {
        result = (0, exports.getRandomLotteryResult)(userBet);
        (0, GameUtil_1.filterLotteryResult)(result, players, 'userWinInfo', filterType);
        if (filterType === 2) {
            if (isSystemWin && result.totalRebate > bet) {
                break;
            }
            if (!isSystemWin && result.totalRebate <= bet) {
                break;
            }
        }
        else {
            if (isSystemWin && result.totalRebate <= bet) {
                break;
            }
            if (!isSystemWin && result.totalRebate > bet) {
                break;
            }
        }
    }
    return result;
};
exports.getWinORLossResult = getWinORLossResult;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiS0FTYWlsb3JTZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vYXBwL3NlcnZpY2VzL0tBU2FpbG9yU2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUE7OztBQUVaLGdEQUF3RDtBQUV4RCxNQUFNLGVBQWUsR0FBRyxFQUFFLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxDQUFDLEVBQUUsSUFBSSxFQUFFLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxDQUFDLEVBQUUsSUFBSSxFQUFFLENBQUM7QUFJakYsTUFBTSxNQUFNLEdBQUcsVUFBVSxHQUFXLEVBQUUsR0FBVztJQUM3QyxJQUFJLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFO1FBQ2hDLE1BQU0sZ0JBQWdCLENBQUM7S0FDMUI7SUFFRCxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztJQUMvQixNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztJQUMvQixNQUFNLEVBQUUsR0FBRyxHQUFHLEdBQUcsR0FBRyxHQUFHLENBQUMsQ0FBQztJQUV6QixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQyxHQUFHLEdBQUcsQ0FBQztBQUNoRCxDQUFDLENBQUM7QUFHRixTQUFnQixPQUFPO0lBQ25CLE1BQU0sTUFBTSxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUMxRCxNQUFNLEdB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