"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const pinus_1 = require("pinus");
var GroupState;
(function (GroupState) {
    GroupState[GroupState["IDLE"] = 0] = "IDLE";
    GroupState[GroupState["BUSY"] = 1] = "BUSY";
    GroupState[GroupState["DESTRUCT"] = 2] = "DESTRUCT";
})(GroupState || (GroupState = {}));
const logger = (0, pinus_1.getLogger)('server_out', __filename);
class RoomGroup {
    constructor(platformId, index, nid, rooms) {
        this.rooms = [];
        this.uidMap = new Map();
        this.platformId = platformId;
        this.index = index;
        this.id = genGroupId(this.platformId, this.index);
        this.rooms = rooms;
        this.nid = nid;
        this.channel = pinus_1.pinus.app.channelService.createChannel(`${this.id}`);
        this.lastUpdateTime = Date.now();
    }
    isIdle() {
        return this.state === GroupState.IDLE;
    }
    async checkPlayersSession() {
        this.lastUpdateTime = Date.now();
        const players = [...this.uidMap.values()];
        if (players.length === 0) {
            return true;
        }
        const sids = players.reduce((sids, { sid }) => sids.add(sid), new Set());
        const results = await Promise.all([...sids.values()].map((sid) => {
            const s = players.filter(p => p.sid === sid);
            return pinus_1.pinus.app.rpc.connector.enterRemote.checkPlayersSession.toServer(sid, s.map(({ uid }) => uid));
        }));
        return results.every(r => !r);
    }
    addRoom(room) {
        this.rooms.push(room);
    }
    setDestructState() {
        this.state = GroupState.DESTRUCT;
    }
    isDestructState() {
        return this.state === GroupState.DESTRUCT;
    }
    findRoomsBySceneId(sceneId) {
        return this.rooms.filter(r => r.sceneId === sceneId);
    }
    getRooms() {
        return this.rooms;
    }
    addPlayer(player) {
        this.addToChannel(player);
        this.uidMap.set(player.uid, { uid: player.uid, sid: player.sid });
        this.lastUpdateTime = Date.now();
        if (this.state === GroupState.IDLE) {
            this.state = GroupState.BUSY;
        }
    }
    removePlayer(player) {
        this.leaveTheChannel(player);
        this.uidMap.delete(player.uid);
        this.lastUpdateTime = Date.now();
        if (this.uidMap.size === 0) {
            this.state = GroupState.IDLE;
            this.idleTime = Date.now();
        }
    }
    leaveTheChannel(player) {
        const member = this.channel.getMember(player.uid);
        member && this.channel.leave(member.uid, member.sid);
    }
    addToChannel(player) {
        if (this.channel.getMember(player.uid)) {
            return;
        }
        if (!this.channel.add(player.uid, player.sid)) {
            logger.warn(`玩家添加盘路通道失败 游戏: ${this.nid} uid: ${player.uid} id: ${this.id}`);
            return;
        }
    }
    pushMessage(route, data) {
        this.channel.pushMessage(route, data);
    }
    destruct() {
        this.rooms = [];
        pinus_1.pinus.app.channelService.destroyChannel(this.id);
        this.channel = null;
        this.uidMap.clear();
    }
}
exports.default = RoomGroup;
function genGroupId(platformId, index) {
    return `${platformId}:${index}`;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm9vbUdyb3VwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vYXBwL2NvbW1vbi9jbGFzc2VzL3N1YmNsYXNzL3Jvb21Hcm91cC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUVBLGlDQUFnRDtBQUdoRCxJQUFLLFVBSUo7QUFKRCxXQUFLLFVBQVU7SUFDWCwyQ0FBSSxDQUFBO0lBQ0osMkNBQUksQ0FBQTtJQUNKLG1EQUFRLENBQUE7QUFDWixDQUFDLEVBSkksVUFBVSxLQUFWLFVBQVUsUUFJZDtBQUVELE1BQU0sTUFBTSxHQUFHLElBQUEsaUJBQVMsRUFBQyxZQUFZLEVBQUUsVUFBVSxDQUFDLENBQUM7QUFFbkQsTUFBcUIsU0FBUztJQXNCMUIsWUFBWSxVQUFrQixFQUFFLEtBQWEsRUFBQyxHQUFXLEVBQUUsS0FBVTtRQWY3RCxVQUFLLEdBQVEsRUFBRSxDQUFDO1FBYXhCLFdBQU0sR0FBNEIsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUd4QyxJQUFJLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQztRQUM3QixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNuQixJQUFJLENBQUMsRUFBRSxHQUFHLFVBQVUsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNsRCxJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNuQixJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQztRQUNmLElBQUksQ0FBQyxPQUFPLEdBQUcsYUFBSyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsYUFBYSxDQUFDLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDcEUsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDckMsQ0FBQztJQUtELE1BQU07UUFDRixPQUFPLElBQUksQ0FBQyxLQUFLLEtBQUssVUFBVSxDQUFDLElB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